# A1 노드 검색 흐름 시각적 다이어그램

## 1. 전체 시스템 아키텍처

```
┏━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃                    A1 Node - Completeness Check                    ┃
┃                         (완전성 검증)                               ┃
┗━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┛
                                  │
                ┌─────────────────┼─────────────────┐
                │                 │                 │
                ↓                 ↓                 ↓
    ┌───────────────────┐ ┌──────────────┐ ┌──────────────────┐
    │ ArticleMatcher    │ │ Matching     │ │ HybridSearcher   │
    │                   │ │ Verifier     │ │                  │
    │ • 멀티벡터 검색   │ │ • LLM 검증   │ │ • FAISS (0.85)   │
    │ • 조 단위 집계    │ │ • 후보 선택  │ │ • Whoosh (0.15)  │
    │ • 역방향 검색     │ │ • 재검증     │ │ • 점수 융합      │
    └───────────────────┘ └──────────────┘ └──────────────────┘
                │                 │                 │
                └─────────────────┼─────────────────┘
                                  │
                                  ↓
                    ┌─────────────────────────┐
                    │ KnowledgeBaseLoader     │
                    │                         │
                    │ • FAISS 인덱스 로드     │
                    │ • Whoosh 인덱스 로드    │
                    │ • 청크 메타데이터 로드  │
                    │ • 인덱스 캐싱           │
                    └─────────────────────────┘
```

## 2. 정방향 매칭 상세 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                        사용자 계약서 조문                            │
│                                                                     │
│  제3조 (데이터 제공 범위)                                            │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐    │
│  │ 하위항목 1      │  │ 하위항목 2      │  │ 하위항목 3      │    │
│  │ "별지1에 기재된"│  │ "데이터 형식은" │  │ "제공 주기는"   │    │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘    │
└───────────┼──────────────────────┼──────────────────────┼───────────┘
            │                      │                      │
            └──────────────────────┼──────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    ArticleMatcher._search_with_sub_items()          │
│                                                                     │
│  각 하위항목별로 독립적으로 처리:                                    │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 1. 정규화 (Normalization)                                     │ │
│  │    • ①②③ 원문자 제거                                         │ │
│  │    • 1. 2. 3. 번호 제거                                       │ │
│  │    • (가) (나) 괄호 제거                                      │ │
│  │    • 앞뒤 공백 제거                                           │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                   ↓                                 │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 2. 쿼리 생성 (Query Building)                                 │ │
│  │    • text_query: 하위항목 본문                                │ │
│  │    • title_query: 조 제목                                     │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                   ↓                                 │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 3. 하이브리드 검색 (Hybrid Search)                            │ │
│  │    HybridSearcher.search()                                    │ │
│  │    ├─ Dense: FAISS 벡터 검색 (가중치 0.85)                   │ │
│  │    │   ├─ text_norm 인덱스 (본문, 0.7)                       │ │
│  │    │   └─ title 인덱스 (제목, 0.3)                           │ │
│  │    └─ Sparse: Whoosh BM25 (가중치 0.15)                      │ │
│  │        ├─ text_norm 필드 (본문, 0.7)                         │ │
│  │        └─ title 필드 (제목, 0.3)                             │ │
│  │                                                               │ │
│  │    결과: Top-K 청크 (기본 1개)                                │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                   ↓                                 │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 4. 조 단위 집계 (_select_best_article_from_chunks)           │ │
│  │    • parent_id로 청크 그룹화                                  │ │
│  │    • 각 조의 최고 점수 선택 (top-1 방식)                      │ │
│  │    • 해당 조의 모든 청크 수집                                 │ │
│  └───────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│              하위항목별 결과 (Sub-item Results)                      │
│                                                                     │
│  하위항목 1 → 표준 제2조: 0.87 (청크 3개)                            │
│  하위항목 2 → 표준 제2조: 0.82 (청크 2개)                            │
│  하위항목 3 → 표준 제3조: 0.79 (청크 1개)                            │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│          ArticleMatcher._aggregate_sub_item_results()               │
│                                                                     │
│  조 단위로 재집계:                                                   │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 표준 제2조 (데이터 제공 범위 및 방식)                         │ │
│  │   • 하위항목 1: 0.87                                          │ │
│  │   • 하위항목 2: 0.82                                          │ │
│  │   → 평균 점수: 0.845                                          │ │
│  │   → 매칭 하위항목: 2개                                        │ │
│  │   → 청크: 5개 (중복 제거)                                     │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 표준 제3조 (데이터 제공 주기)                                 │ │
│  │   • 하위항목 3: 0.79                                          │ │
│  │   → 평균 점수: 0.79                                           │ │
│  │   → 매칭 하위항목: 1개                                        │ │
│  │   → 청크: 1개                                                 │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  정렬 기준:                                                          │
│    1순위: 매칭 하위항목 개수 (많은 순)                              │
│    2순위: 평균 점수 (높은 순)                                        │
│    3순위: 조 번호 (낮은 순)                                          │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                  후보 조문 리스트 (Candidates)                       │
│                                                                     │
│  1위: 제2조 (평균 0.845, 하위항목 2개)                               │
│  2위: 제3조 (평균 0.79, 하위항목 1개)                                │
└─────────────────────────────────────────────────────────────────────┘
```



## 3. LLM 검증 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                    후보 조문 리스트 (Top-5)                          │
│                                                                     │
│  1. 제2조 (데이터 제공 범위 및 방식) - 0.845, 하위항목 2개           │
│  2. 제3조 (데이터 제공 주기) - 0.79, 하위항목 1개                    │
│  3. 제5조 (데이터 품질 기준) - 0.72, 하위항목 1개                    │
│  4. 제7조 (데이터 보안) - 0.68, 하위항목 1개                         │
│  5. 제10조 (계약 변경) - 0.65, 하위항목 1개                          │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│            MatchingVerifier._select_relevant_articles()             │
│                                                                     │
│  LLM 프롬프트 구성:                                                  │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ ## 사용자 계약서 조항                                         │ │
│  │ 제3조 (데이터 제공 범위)                                      │ │
│  │ 갑은 다음 각 호의 데이터를 제공한다.                          │ │
│  │ - 별지1에 기재된 데이터 항목                                  │ │
│  │ - 데이터 형식은 JSON 또는 CSV로 한다                          │ │
│  │ - 제공 주기는 월 1회로 하되, 필요시 협의하여 변경할 수 있다  │ │
│  │                                                               │ │
│  │ ## 후보 표준계약서 조항들                                     │ │
│  │                                                               │ │
│  │ 제2조 (데이터 제공 범위 및 방식) [유사도: 0.845]              │ │
│  │   제2조_본문: 갑은 별지1에 기재된 데이터를...                 │ │
│  │   제2조_1항: 데이터 형식은 JSON, CSV, XML 중...               │ │
│  │   제2조_2항: 데이터 제공 방식은...                            │ │
│  │                                                               │ │
│  │ 제3조 (데이터 제공 주기) [유사도: 0.79]                       │ │
│  │   제3조_본문: 데이터 제공 주기는 월 1회로 한다...             │ │
│  │   제3조_1항: 필요시 양 당사자 협의하여...                     │ │
│  │                                                               │ │
│  │ 제5조 (데이터 품질 기준) [유사도: 0.72]                       │ │
│  │   제5조_본문: 제공되는 데이터는 다음의 품질 기준을...         │ │
│  │   ...                                                         │ │
│  │                                                               │ │
│  │ **과제**: 위의 후보 조항들 중에서 사용자 계약서 조항과        │ │
│  │ **실제로 관련있는** 표준계약서 조항들을 **모두** 선택하세요.  │ │
│  │                                                               │ │
│  │ **중요 사항**:                                                │ │
│  │ - 사용자 조항의 내용이 여러 조문에 걸쳐 있을 수 있습니다     │ │
│  │ - 관련있는 조항이라면 모두 선택해야 합니다                   │ │
│  │ - 명확히 관련없는 조항은 제외하세요                          │ │
│  │                                                               │ │
│  │ **응답 형식** (조항 ID만 나열):                               │ │
│  │ 선택된 조항: 제1조, 제3조, 제5조                              │ │
│  └───────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    Azure OpenAI API 호출                             │
│                                                                     │
│  Model: gpt-4o                                                      │
│  Temperature: 0.3                                                   │
│  Max Tokens: 500                                                    │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        LLM 응답                                      │
│                                                                     │
│  선택된 조항: 제2조, 제3조                                           │
│                                                                     │
│  이유:                                                               │
│  - 제2조: 사용자 조항의 "별지1에 기재된 데이터"와 "데이터 형식"     │
│           내용이 표준 제2조의 "데이터 제공 범위 및 방식"에 해당      │
│  - 제3조: 사용자 조항의 "제공 주기는 월 1회"와 "협의하여 변경"      │
│           내용이 표준 제3조의 "데이터 제공 주기"에 해당              │
│  - 제5조: 품질 기준 관련 내용이 사용자 조항에 없어 제외             │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│              MatchingVerifier._parse_selection_response()           │
│                                                                     │
│  정규표현식으로 조항 ID 추출:                                        │
│    pattern = r'제\d+조'                                             │
│    found_ids = ["제2조", "제3조"]                                    │
│                                                                     │
│  후보 목록과 대조하여 유효성 검증                                    │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      최종 검증 결과                                  │
│                                                                     │
│  {                                                                  │
│    "matched": true,                                                 │
│    "selected_articles": ["제2조", "제3조"],                          │
│    "verification_details": [],                                      │
│    "prompt_tokens": 1250,                                           │
│    "completion_tokens": 85,                                         │
│    "total_tokens": 1335                                             │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
```



## 4. 하이브리드 검색 상세 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                        검색 쿼리 입력                                │
│                                                                     │
│  text_query: "별지1에 기재된 데이터 항목"                            │
│  title_query: "데이터 제공 범위"                                     │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                    ┌──────────────┴──────────────┐
                    │                             │
                    ↓                             ↓
┌──────────────────────────────────┐  ┌──────────────────────────────────┐
│      Dense 검색 (FAISS)          │  │     Sparse 검색 (Whoosh)         │
│      가중치: 0.85                │  │     가중치: 0.15                 │
└──────────────────────────────────┘  └──────────────────────────────────┘
                    │                             │
        ┌───────────┴───────────┐     ┌───────────┴───────────┐
        │                       │     │                       │
        ↓                       ↓     ↓                       ↓
┌──────────────┐      ┌──────────────┐┌──────────────┐┌──────────────┐
│ text_norm    │      │ title        ││ text_norm    ││ title        │
│ 인덱스 검색  │      │ 인덱스 검색  ││ 필드 검색    ││ 필드 검색    │
│              │      │              ││ (BM25)       ││ (BM25)       │
│ 가중치: 0.7  │      │ 가중치: 0.3  ││ 가중치: 0.7  ││ 가중치: 0.3  │
└──────┬───────┘      └──────┬───────┘└──────┬───────┘└──────┬───────┘
       │                     │               │               │
       │  L2 거리 → 유사도   │               │   BM25 점수   │
       │  변환               │               │               │
       │                     │               │               │
       └──────────┬──────────┘               └───────┬───────┘
                  │                                  │
                  ↓                                  ↓
       ┌────────────────────┐           ┌────────────────────┐
       │ 청크별 Dense 점수  │           │ 청크별 Sparse 점수 │
       │                    │           │                    │
       │ chunk_001: 0.87    │           │ chunk_001: 12.5    │
       │ chunk_002: 0.82    │           │ chunk_003: 10.2    │
       │ chunk_003: 0.79    │           │ chunk_005: 8.7     │
       │ chunk_004: 0.75    │           │ chunk_002: 7.3     │
       │ chunk_005: 0.71    │           │ chunk_007: 6.1     │
       │ ...                │           │ ...                │
       │ (Top-50)           │           │ (Top-50)           │
       └────────┬───────────┘           └────────┬───────────┘
                │                                │
                └────────────┬───────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    점수 정규화 (Min-Max)                             │
│                                                                     │
│  Dense 점수:  [0.87, 0.82, 0.79, 0.75, 0.71, ...]                   │
│    → 정규화: [1.0, 0.75, 0.5, 0.25, 0.0, ...]                       │
│                                                                     │
│  Sparse 점수: [12.5, 10.2, 8.7, 7.3, 6.1, ...]                      │
│    → 정규화: [1.0, 0.6, 0.4, 0.2, 0.0, ...]                         │
│                                                                     │
│  normalized = (score - min) / (max - min)                          │
└─────────────────────────────────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    점수 융합 (Weighted Sum)                          │
│                                                                     │
│  청크별 최종 점수 계산:                                              │
│                                                                     │
│  chunk_001:                                                         │
│    dense_norm = 1.0, sparse_norm = 1.0                              │
│    final = 1.0 × 0.85 + 1.0 × 0.15 = 1.0                            │
│                                                                     │
│  chunk_002:                                                         │
│    dense_norm = 0.75, sparse_norm = 0.2                             │
│    final = 0.75 × 0.85 + 0.2 × 0.15 = 0.6675                        │
│                                                                     │
│  chunk_003:                                                         │
│    dense_norm = 0.5, sparse_norm = 0.6                              │
│    final = 0.5 × 0.85 + 0.6 × 0.15 = 0.515                          │
│                                                                     │
│  ...                                                                │
│                                                                     │
│  Adaptive Weighting:                                                │
│    - Sparse 결과 없으면 Dense 가중치 1.0으로 자동 조정              │
│    - final = dense_norm × 1.0                                       │
└─────────────────────────────────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    최종 정렬 및 반환                                 │
│                                                                     │
│  final_score 기준 내림차순 정렬:                                     │
│                                                                     │
│  1. chunk_001: 1.0 (parent_id: 제2조)                               │
│  2. chunk_002: 0.6675 (parent_id: 제2조)                            │
│  3. chunk_003: 0.515 (parent_id: 제3조)                             │
│  4. chunk_004: 0.4125 (parent_id: 제2조)                            │
│  5. chunk_005: 0.3525 (parent_id: 제5조)                            │
│  ...                                                                │
│                                                                     │
│  Top-K 청크 반환 (기본 K=1)                                          │
└─────────────────────────────────────────────────────────────────────┘
```



## 5. 역방향 검증 상세 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                  정방향 매칭 완료 후 누락 조문 식별                  │
│                                                                     │
│  전체 표준 조문: 15개                                                │
│  매칭된 조문: 12개 (제1조, 제2조, 제3조, ...)                        │
│  누락된 조문: 3개 (제4조, 제9조, 제14조)                             │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│        STEP 1: 사용자 FAISS 인덱스 생성 (1회만)                      │
│        ArticleMatcher.build_user_faiss_index()                      │
│                                                                     │
│  사용자 계약서의 모든 하위항목 임베딩 수집:                          │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 제1조 (계약 목적)                                             │ │
│  │   ├─ 하위항목 1 임베딩 [3072 dim]                            │ │
│  │   ├─ 하위항목 2 임베딩 [3072 dim]                            │ │
│  │   └─ 하위항목 3 임베딩 [3072 dim]                            │ │
│  │                                                               │ │
│  │ 제2조 (용어 정의)                                             │ │
│  │   ├─ 하위항목 1 임베딩 [3072 dim]                            │ │
│  │   └─ 하위항목 2 임베딩 [3072 dim]                            │ │
│  │                                                               │ │
│  │ ...                                                           │ │
│  │                                                               │ │
│  │ 제15조 (기타)                                                 │ │
│  │   └─ 하위항목 1 임베딩 [3072 dim]                            │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  총 45개 하위항목 임베딩 수집                                        │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ FAISS 인덱스 구축                                             │ │
│  │                                                               │ │
│  │ import faiss                                                  │ │
│  │ embeddings_array = np.array(embeddings_list, dtype=float32)  │ │
│  │ dimension = 3072                                              │ │
│  │ faiss_index = faiss.IndexFlatL2(dimension)                    │ │
│  │ faiss_index.add(embeddings_array)                             │ │
│  │                                                               │ │
│  │ embedding_map = [                                             │ │
│  │   {'user_article': 제1조, 'sub_item_index': 1, ...},         │ │
│  │   {'user_article': 제1조, 'sub_item_index': 2, ...},         │ │
│  │   ...                                                         │ │
│  │ ]                                                             │ │
│  └───────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│        STEP 2: 각 누락 조문에 대해 역방향 검색                       │
│        ArticleMatcher.find_matching_user_articles()                 │
│                                                                     │
│  누락 조문 1: 표준 제4조 (데이터 보안)                               │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 표준 제4조의 청크들:                                          │ │
│  │   ├─ 청크 1: "갑은 제공받은 데이터의 보안을..."              │ │
│  │   ├─ 청크 2: "데이터 암호화 및 접근 통제..."                 │ │
│  │   ├─ 청크 3: "보안 사고 발생 시 즉시 통보..."                │ │
│  │   └─ 청크 4: "보안 관련 법규 준수..."                        │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  각 청크별로 역방향 검색:                                            │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 청크 1 처리:                                                  │ │
│  │   1. 표준 FAISS 인덱스에서 청크 1 임베딩 추출                │ │
│  │      standard_faiss_text.reconstruct(chunk_index)             │ │
│  │                                                               │ │
│  │   2. 사용자 FAISS 인덱스 검색 (Top-10 하위항목)              │ │
│  │      user_faiss_index.search(chunk_embedding, k=10)           │ │
│  │                                                               │ │
│  │      결과:                                                    │ │
│  │      - 사용자 제5조 하위항목 2: L2=0.45 → similarity=0.69     │ │
│  │      - 사용자 제5조 하위항목 3: L2=0.52 → similarity=0.66     │ │
│  │      - 사용자 제8조 하위항목 1: L2=0.61 → similarity=0.62     │ │
│  │      - 사용자 제12조 하위항목 1: L2=0.73 → similarity=0.58    │ │
│  │      - ...                                                    │ │
│  │                                                               │ │
│  │   3. 임계값 필터링 (similarity > 0.5)                         │ │
│  │      - 사용자 제5조 하위항목 2: 0.69 ✓                        │ │
│  │      - 사용자 제5조 하위항목 3: 0.66 ✓                        │ │
│  │      - 사용자 제8조 하위항목 1: 0.62 ✓                        │ │
│  │      - 사용자 제12조 하위항목 1: 0.58 ✓                       │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 청크 2, 3, 4도 동일하게 처리...                               │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  조 단위로 집계:                                                     │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ 사용자 제5조:                                                 │ │
│  │   - 매칭 하위항목: 5개                                        │ │
│  │   - 점수: [0.69, 0.66, 0.71, 0.68, 0.72]                      │ │
│  │   - max_score: 0.72                                           │ │
│  │   - avg_score: 0.692                                          │ │
│  │                                                               │ │
│  │ 사용자 제8조:                                                 │ │
│  │   - 매칭 하위항목: 3개                                        │ │
│  │   - 점수: [0.62, 0.65, 0.61]                                  │ │
│  │   - max_score: 0.65                                           │ │
│  │   - avg_score: 0.627                                          │ │
│  │                                                               │ │
│  │ 사용자 제12조:                                                │ │
│  │   - 매칭 하위항목: 2개                                        │ │
│  │   - 점수: [0.58, 0.56]                                        │ │
│  │   - max_score: 0.58                                           │ │
│  │   - avg_score: 0.57                                           │ │
│  └───────────────────────────────────────────────────────────────┘ │
│                                                                     │
│  max_score 기준 정렬 및 Top-3 선택:                                  │
│    1. 사용자 제5조: 0.72                                             │
│    2. 사용자 제8조: 0.65                                             │
│    3. 사용자 제12조: 0.58                                            │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│        STEP 3: LLM 재검증                                            │
│        MatchingVerifier.verify_missing_article_forward()            │
│                                                                     │
│  프롬프트 구성:                                                      │
│                                                                     │
│  ┌───────────────────────────────────────────────────────────────┐ │
│  │ **표준 조항 (제4조):**                                        │ │
│  │ 갑은 제공받은 데이터의 보안을 유지해야 한다.                  │ │
│  │ - 데이터 암호화 및 접근 통제 조치를 취한다                   │ │
│  │ - 보안 사고 발생 시 즉시 통보한다                            │ │
│  │ - 보안 관련 법규를 준수한다                                  │ │
│  │                                                               │ │
│  │ **사용자 계약서 후보 조항 (Top-3):**                          │ │
│  │                                                               │ │
│  │ **후보 1: 제5조 (데이터 보호)** (유사도: 0.72)               │ │
│  │ 을은 제공받은 데이터를 안전하게 보관해야 한다.                │ │
│  │ - 암호화 기술을 적용한다                                     │ │
│  │ - 접근 권한을 제한한다                                       │ │
│  │ - 보안 사고 시 즉시 보고한다                                 │ │
│  │                                                               │ │
│  │ **후보 2: 제8조 (정보 보안)** (유사도: 0.65)                 │ │
│  │ 양 당사자는 정보 보안을 위해 노력한다.                       │ │
│  │ - 보안 정책을 수립한다                                       │ │
│  │                                                               │ │
│  │ **후보 3: 제12조 (법규 준수)** (유사도: 0.58)                │ │
│  │ 양 당사자는 관련 법규를 준수한다.                            │ │
│  │ - 개인정보보호법 준수                                        │ │
│  │                                                               │ │
│  │ **과제**: 각 후보가 표준 조항의 내용을 포함하는지 분석       │ │
│  └───────────────────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    Azure OpenAI API 호출                             │
│                                                                     │
│  Model: gpt-4o                                                      │
│  Temperature: 0.1                                                   │
│  Max Tokens: 1500                                                   │
│  Response Format: JSON                                              │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                        LLM 응답 (JSON)                               │
│                                                                     │
│  {                                                                  │
│    "candidates": [                                                  │
│      {                                                              │
│        "candidate_id": "제5조",                                      │
│        "is_match": true,                                            │
│        "confidence": 0.85,                                          │
│        "match_type": "부분 일치(표현 차이)",                         │
│        "reasoning": "후보 제5조는 '데이터를 안전하게 보관'이라고    │
│                      명시하여 표준의 '데이터 보안 유지'와 유사.     │
│                      암호화, 접근 통제, 보안 사고 보고 등           │
│                      핵심 요소를 모두 포함하고 있음.",              │
│        "risk": "해당 조항이 없으면 데이터 보안 책임이 불명확해져   │
│                 보안 사고 발생 시 분쟁 가능성이 높아집니다.",       │
│        "recommendation": "제5조가 표준 제4조의 내용을 포함하고      │
│                          있으므로 누락이 아닙니다."                 │
│      },                                                             │
│      {                                                              │
│        "candidate_id": "제8조",                                      │
│        "is_match": false,                                           │
│        "confidence": 0.4,                                           │
│        "match_type": "부분 일치(표현 차이)",                         │
│        "reasoning": "후보 제8조는 '정보 보안을 위해 노력'이라는     │
│                      일반적 표현만 있고, 구체적인 보안 조치가       │
│                      명시되지 않아 표준 조항의 내용을 충분히        │
│                      포함하지 못함.",                               │
│        "risk": "...",                                               │
│        "recommendation": "..."                                      │
│      },                                                             │
│      {                                                              │
│        "candidate_id": "제12조",                                     │
│        "is_match": false,                                           │
│        "confidence": 0.3,                                           │
│        "match_type": "무관",                                         │
│        "reasoning": "후보 제12조는 법규 준수에 관한 일반 조항으로   │
│                      데이터 보안과는 직접적 관련이 없음.",          │
│        "risk": "...",                                               │
│        "recommendation": "..."                                      │
│      }                                                              │
│    ],                                                               │
│    "summary": "제5조가 표준 제4조의 데이터 보안 관련 내용을         │
│                대부분 포함하고 있어 누락이 아닌 것으로 판단됨.",    │
│    "overall_risk": "해당 조항이 없으면 데이터 보안 책임 소재가      │
│                     불명확해져 보안 사고 발생 시 법적 분쟁 가능성이 │
│                     높아지고, 계약 이행 과정에서 보안 기준에 대한  │
│                     해석 차이로 인한 갈등이 발생할 수 있습니다."    │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│                      최종 재검증 결과                                │
│                                                                     │
│  {                                                                  │
│    "standard_article_id": "urn:std:provide:art:004",                │
│    "standard_article_title": "데이터 보안",                          │
│    "is_truly_missing": false,  ← 실제로는 누락이 아님               │
│    "confidence": 0.85,                                              │
│    "matched_user_article": {                                        │
│      "number": 5,                                                   │
│      "title": "데이터 보호",                                         │
│      ...                                                            │
│    },                                                               │
│    "reasoning": "후보 제5조는 '데이터를 안전하게 보관'이라고...",    │
│    "recommendation": "제5조가 표준 제4조의 내용을 포함하고...",      │
│    "evidence": "제5조가 표준 조항의 내용을 포함하고 있어...",        │
│    "risk_assessment": "해당 조항이 없으면 데이터 보안 책임...",      │
│    "top_candidates": [...],                                         │
│    "candidates_analysis": [...]                                     │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
```



## 6. 점수 계산 수식 시각화

### 하이브리드 검색 점수

```
┌─────────────────────────────────────────────────────────────────────┐
│                    최종 점수 계산 공식                               │
└─────────────────────────────────────────────────────────────────────┘

Step 1: Dense 점수 (FAISS 벡터 검색)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  text_similarity = 1 / (1 + L2_distance_text)
  title_similarity = 1 / (1 + L2_distance_title)
  
  dense_score = text_similarity × 0.7 + title_similarity × 0.3
                └─────────┬─────────┘   └──────────┬──────────┘
                      본문 가중치              제목 가중치


Step 2: Sparse 점수 (Whoosh BM25)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  text_bm25 = BM25(query, text_norm_field)
  title_bm25 = BM25(query, title_field)
  
  sparse_score = text_bm25 × 0.7 + title_bm25 × 0.3
                 └────┬────┘       └─────┬─────┘
                  본문 가중치          제목 가중치


Step 3: 정규화 (Min-Max Normalization)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  normalized_dense = (dense_score - min_dense) / (max_dense - min_dense)
  
  normalized_sparse = (sparse_score - min_sparse) / (max_sparse - min_sparse)


Step 4: 가중합 융합 (Weighted Sum Fusion)
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  final_score = normalized_dense × 0.85 + normalized_sparse × 0.15
                └──────────┬──────────┘   └───────────┬───────────┘
                    Dense 가중치              Sparse 가중치
  
  
  Adaptive Weighting (Sparse 결과 없을 때):
  ─────────────────────────────────────────
  
  final_score = normalized_dense × 1.0
                └──────────┬──────────┘
                  자동 조정 (0.85 → 1.0)


┌─────────────────────────────────────────────────────────────────────┐
│                        예시 계산                                     │
└─────────────────────────────────────────────────────────────────────┘

청크 A:
  L2_distance_text = 0.3  → text_similarity = 1/(1+0.3) = 0.769
  L2_distance_title = 0.5 → title_similarity = 1/(1+0.5) = 0.667
  
  dense_score = 0.769 × 0.7 + 0.667 × 0.3 = 0.738
  
  text_bm25 = 12.5
  title_bm25 = 8.3
  
  sparse_score = 12.5 × 0.7 + 8.3 × 0.3 = 11.24
  
  정규화 (가정: min_dense=0.5, max_dense=0.9, min_sparse=5.0, max_sparse=15.0):
    normalized_dense = (0.738 - 0.5) / (0.9 - 0.5) = 0.595
    normalized_sparse = (11.24 - 5.0) / (15.0 - 5.0) = 0.624
  
  final_score = 0.595 × 0.85 + 0.624 × 0.15 = 0.599
```

### 멀티벡터 집계 점수

```
┌─────────────────────────────────────────────────────────────────────┐
│                조 단위 집계 점수 계산                                │
└─────────────────────────────────────────────────────────────────────┘

사용자 조문의 하위항목별 검색 결과:
  하위항목 1 → 표준 제2조: 0.87
  하위항목 2 → 표준 제2조: 0.82
  하위항목 3 → 표준 제3조: 0.79
  하위항목 4 → 표준 제2조: 0.75


조 단위 집계:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  표준 제2조:
    매칭 하위항목: [1, 2, 4]
    점수: [0.87, 0.82, 0.75]
    
    평균 점수 = (0.87 + 0.82 + 0.75) / 3 = 0.813
    매칭 개수 = 3
  
  표준 제3조:
    매칭 하위항목: [3]
    점수: [0.79]
    
    평균 점수 = 0.79
    매칭 개수 = 1


정렬 기준:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  1순위: 매칭 하위항목 개수 (내림차순)
  2순위: 평균 점수 (내림차순)
  3순위: 조 번호 (오름차순)
  
  결과:
    1위: 제2조 (매칭 3개, 평균 0.813)
    2위: 제3조 (매칭 1개, 평균 0.79)
```

### 역방향 검색 유사도

```
┌─────────────────────────────────────────────────────────────────────┐
│                역방향 검색 유사도 계산                               │
└─────────────────────────────────────────────────────────────────────┘

표준 청크 임베딩 → 사용자 하위항목 임베딩 검색:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  FAISS L2 거리 기반 유사도:
  
  similarity = 1 / (1 + L2_distance)
  
  
  예시:
    L2_distance = 0.45 → similarity = 1/(1+0.45) = 0.69
    L2_distance = 0.52 → similarity = 1/(1+0.52) = 0.66
    L2_distance = 0.61 → similarity = 1/(1+0.61) = 0.62


조 단위 집계:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  사용자 제5조:
    매칭 하위항목: 5개
    점수: [0.69, 0.66, 0.71, 0.68, 0.72]
    
    max_score = max(0.69, 0.66, 0.71, 0.68, 0.72) = 0.72
    avg_score = (0.69 + 0.66 + 0.71 + 0.68 + 0.72) / 5 = 0.692
  
  
  정렬: max_score 기준 내림차순
```

---

## 7. 성능 최적화 전략 시각화

```
┌─────────────────────────────────────────────────────────────────────┐
│                    임베딩 재사용 전략                                │
└─────────────────────────────────────────────────────────────────────┘

사용자 계약서 업로드 시:
┌─────────────────────────────────────────────────────────────────────┐
│  파싱 단계 (FastAPI)                                                 │
│  ├─ DOCX 파싱                                                        │
│  ├─ 조문 구조 추출                                                   │
│  └─ 임베딩 생성 (EmbeddingService)                                   │
│      ├─ 각 조 제목 임베딩                                            │
│      └─ 각 하위항목 본문 임베딩                                      │
│          │                                                           │
│          ↓                                                           │
│  DB 저장 (embeddings 테이블)                                         │
│  ├─ contract_id                                                      │
│  ├─ article_number                                                   │
│  ├─ title_embedding [3072 dim]                                       │
│  └─ sub_items: [                                                     │
│      {index: 1, text_embedding: [...]},                              │
│      {index: 2, text_embedding: [...]},                              │
│      ...                                                             │
│    ]                                                                 │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│  A1 노드 검색 시 (Consistency Agent)                                 │
│  ├─ DB에서 임베딩 로드 (EmbeddingLoader)                             │
│  │   └─ Azure OpenAI API 호출 0회 ✓                                 │
│  │                                                                   │
│  ├─ 정방향 검색                                                       │
│  │   └─ 사전 계산된 임베딩 사용                                      │
│  │       └─ API 호출 0회 ✓                                           │
│  │                                                                   │
│  ├─ 역방향 검색                                                       │
│  │   └─ 사전 계산된 임베딩 사용                                      │
│  │       └─ API 호출 0회 ✓                                           │
│  │                                                                   │
│  └─ LLM 검증만 API 사용                                              │
│      └─ gpt-4o 호출 (필수)                                           │
└─────────────────────────────────────────────────────────────────────┘

토큰 절약 효과:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  사용자 조문 15개, 각 조문 평균 3개 하위항목 가정:
  
  임베딩 재사용 없이:
    - 정방향 검색: 15조 × 3하위항목 × 2(text+title) = 90회 API 호출
    - 역방향 검색: 3누락조 × 4청크 = 12회 API 호출
    - 총 102회 임베딩 API 호출
  
  임베딩 재사용 시:
    - 정방향 검색: 0회 API 호출 ✓
    - 역방향 검색: 0회 API 호출 ✓
    - 총 0회 임베딩 API 호출 ✓
  
  절약: 102회 × 약 $0.00013/1K tokens = 상당한 비용 절감
```

```
┌─────────────────────────────────────────────────────────────────────┐
│                    인덱스 캐싱 전략                                  │
└─────────────────────────────────────────────────────────────────────┘

KnowledgeBaseLoader (싱글톤):
┌─────────────────────────────────────────────────────────────────────┐
│  메모리 캐시:                                                        │
│  {                                                                  │
│    "provide": {                                                     │
│      "faiss_indexes": (text_index, title_index),  ← 메모리 상주    │
│      "chunks": [...],                              ← 메모리 상주    │
│      "whoosh_indexer": WhooshSearcher(...)         ← 메모리 상주    │
│    },                                                               │
│    "create": { ... },                                               │
│    "process": { ... },                                              │
│    ...                                                              │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘
                                   │
                                   ↓
┌─────────────────────────────────────────────────────────────────────┐
│  HybridSearcher 인스턴스 캐싱:                                       │
│  {                                                                  │
│    "provide": HybridSearcher(...),  ← 인덱스 로드 완료              │
│    "create": HybridSearcher(...),                                   │
│    ...                                                              │
│  }                                                                  │
└─────────────────────────────────────────────────────────────────────┘

재사용 효과:
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

  사용자 조문 15개 검색 시:
  
  캐싱 없이:
    - 각 조문마다 FAISS 인덱스 로드: 15회
    - 각 조문마다 Whoosh 인덱스 로드: 15회
    - 각 조문마다 청크 데이터 로드: 15회
    - 총 45회 디스크 I/O
  
  캐싱 시:
    - 첫 조문: FAISS, Whoosh, 청크 로드 (1회)
    - 나머지 14개 조문: 캐시에서 재사용 (0회 I/O)
    - 총 1회 디스크 I/O ✓
  
  속도 향상: 약 15배
```

---

**작성일**: 2025-11-03  
**버전**: 1.0
