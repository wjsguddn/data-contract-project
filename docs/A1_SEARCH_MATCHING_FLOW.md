# A1 노드 검색 및 매칭 흐름 상세 분석

## 개요

A1 노드(Completeness Check)는 사용자 계약서의 각 조문이 표준계약서의 어떤 조문과 대응되는지 찾아내는 **완전성 검증** 작업을 수행합니다.

핵심 특징:
- **멀티벡터 검색**: 사용자 조문의 각 하위항목을 개별 쿼리로 사용
- **하이브리드 검색**: FAISS(시멘틱) + Whoosh(키워드) 결합
- **제목/본문 분리**: 제목과 본문을 별도로 검색하여 가중 평균
- **LLM 검증**: 검색 결과를 LLM으로 재검증
- **역방향 검증**: 누락 조문에 대한 재확인

---

## 전체 아키텍처

```
┌─────────────────────────────────────────────────────────────────┐
│                      A1 Node (CompletenessCheckNode)            │
│                                                                  │
│  ┌──────────────────┐  ┌──────────────────┐  ┌───────────────┐ │
│  │ ArticleMatcher   │  │ MatchingVerifier │  │ HybridSearcher│ │
│  │ (검색 엔진)       │  │ (LLM 검증)        │  │ (FAISS+Whoosh)│ │
│  └──────────────────┘  └──────────────────┘  └───────────────┘ │
└─────────────────────────────────────────────────────────────────┘
```

---

## 1단계: 정방향 매칭 (사용자 → 표준)

### 1.1 전체 흐름

```
사용자 조문 (제N조)
    │
    ├─ 하위항목 1 ──┐
    ├─ 하위항목 2 ──┼─→ ArticleMatcher.find_matching_article()
    └─ 하위항목 3 ──┘
            │
            ↓
    [멀티벡터 검색]
            │
            ↓
    후보 조문 리스트 (조 단위 집계)
            │
            ↓
    MatchingVerifier.verify_matching()
            │
            ↓
    최종 매칭 조문 (1개 이상)
```



### 1.2 멀티벡터 검색 상세

#### ArticleMatcher._search_with_sub_items()

```
사용자 조문: 제3조 (데이터 제공 범위)
├─ 하위항목 1: "갑은 별지1에 기재된 데이터를 제공한다"
├─ 하위항목 2: "데이터 형식은 JSON으로 한다"
└─ 하위항목 3: "제공 주기는 월 1회로 한다"

각 하위항목별로:
┌──────────────────────────────────────────────────────────┐
│ 1. 정규화 (번호 제거)                                      │
│    "①" "1." "(가)" 등 제거                                │
├──────────────────────────────────────────────────────────┤
│ 2. 쿼리 생성 (제목/본문 분리)                              │
│    - text_query: 하위항목 본문                            │
│    - title_query: 조 제목                                 │
├──────────────────────────────────────────────────────────┤
│ 3. 하이브리드 검색 (top-k 청크)                           │
│    HybridSearcher.search()                                │
│    ├─ Dense: FAISS 벡터 검색 (0.85)                      │
│    │   ├─ text_norm 인덱스 (본문, 0.7)                   │
│    │   └─ title 인덱스 (제목, 0.3)                       │
│    └─ Sparse: Whoosh BM25 (0.15)                         │
│        ├─ text_norm 필드 (본문, 0.7)                     │
│        └─ title 필드 (제목, 0.3)                         │
├──────────────────────────────────────────────────────────┤
│ 4. 청크를 조 단위로 집계                                   │
│    _select_best_article_from_chunks()                     │
│    - parent_id로 그룹화                                   │
│    - 조별 최고 점수 선택 (top-1 방식)                     │
└──────────────────────────────────────────────────────────┘
```

#### 하위항목별 결과 예시

```
하위항목 1 검색 결과:
  → 표준 제2조: 0.87 (청크 3개 매칭)
  
하위항목 2 검색 결과:
  → 표준 제2조: 0.82 (청크 2개 매칭)
  
하위항목 3 검색 결과:
  → 표준 제3조: 0.79 (청크 1개 매칭)
```



### 1.3 조 단위 집계

#### ArticleMatcher._aggregate_sub_item_results()

```
하위항목별 결과를 조 단위로 집계:

표준 제2조:
  - 하위항목 1: 0.87
  - 하위항목 2: 0.82
  → 평균: 0.845, 매칭 하위항목: 2개

표준 제3조:
  - 하위항목 3: 0.79
  → 평균: 0.79, 매칭 하위항목: 1개

정렬 기준:
  1. 매칭 하위항목 개수 (많은 순)
  2. 평균 유사도 (높은 순)
  3. 조 번호 (낮은 순)

최종 순위:
  1위: 표준 제2조 (하위항목 2개, 평균 0.845)
  2위: 표준 제3조 (하위항목 1개, 평균 0.79)
```

---

## 2단계: LLM 매칭 검증

### 2.1 MatchingVerifier.verify_matching()

```
입력: 후보 조문 리스트 (top-5)
  ├─ 표준 제2조 (0.845, 하위항목 2개)
  ├─ 표준 제3조 (0.79, 하위항목 1개)
  └─ ...

LLM 프롬프트:
┌────────────────────────────────────────────────────────┐
│ ## 사용자 계약서 조항                                   │
│ 제3조 (데이터 제공 범위)                                │
│ - 갑은 별지1에 기재된 데이터를 제공한다                 │
│ - 데이터 형식은 JSON으로 한다                           │
│ - 제공 주기는 월 1회로 한다                             │
│                                                        │
│ ## 후보 표준계약서 조항들                               │
│ 제2조 (데이터 제공 범위 및 방식) [유사도: 0.845]        │
│   - 제2조_본문: 갑은 별지1에 기재된...                  │
│   - 제2조_1항: 데이터 형식은...                         │
│                                                        │
│ 제3조 (데이터 제공 주기) [유사도: 0.79]                 │
│   - 제3조_본문: 데이터 제공 주기는...                   │
│                                                        │
│ **과제**: 실제로 관련있는 표준계약서 조항을 모두 선택   │
└────────────────────────────────────────────────────────┘

LLM 응답:
  선택된 조항: 제2조, 제3조

최종 결과:
  matched: true
  selected_articles: ["제2조", "제3조"]
```



---

## 3단계: 역방향 검증 (표준 → 사용자)

### 3.1 누락 조문 재검증 흐름

```
정방향 매칭 완료 후:
  - 매칭된 표준 조문: 제2조, 제3조, 제5조
  - 누락된 표준 조문: 제1조, 제4조, 제6조

각 누락 조문에 대해:
┌──────────────────────────────────────────────────────────┐
│ 1. 사용자 조문 FAISS 인덱스 생성 (1회만)                 │
│    ArticleMatcher.build_user_faiss_index()               │
│    - 사용자 계약서의 모든 하위항목 임베딩 수집           │
│    - FAISS 인덱스 구축                                   │
├──────────────────────────────────────────────────────────┤
│ 2. 역방향 검색 (표준 → 사용자)                           │
│    ArticleMatcher.find_matching_user_articles()          │
│    - 표준 조문의 각 청크로 사용자 FAISS 검색             │
│    - Top-3 사용자 조문 후보 추출                         │
├──────────────────────────────────────────────────────────┤
│ 3. LLM 재검증                                            │
│    MatchingVerifier.verify_missing_article_forward()     │
│    - 후보 조문들이 표준 조문의 내용을 포함하는지 분석    │
│    - 실제 누락 여부 판단                                 │
└──────────────────────────────────────────────────────────┘
```

### 3.2 역방향 검색 상세

#### 표준 조문 → 사용자 조문 검색

```
표준 제1조 (계약의 목적)
├─ 청크 1: "본 계약은 데이터 제공에 관한..."
├─ 청크 2: "데이터 활용 목적은..."
└─ 청크 3: "양 당사자의 권리와 의무를..."

각 청크별로:
┌────────────────────────────────────────────────────┐
│ 1. 표준 FAISS 인덱스에서 청크 임베딩 추출          │
│    standard_faiss_text.reconstruct(chunk_index)    │
├────────────────────────────────────────────────────┤
│ 2. 사용자 FAISS 인덱스 검색 (Top-10 하위항목)      │
│    user_faiss_index.search(chunk_embedding, k=10)  │
├────────────────────────────────────────────────────┤
│ 3. L2 거리 → 유사도 변환                           │
│    similarity = 1.0 / (1.0 + distance)             │
├────────────────────────────────────────────────────┤
│ 4. 조 단위로 집계                                  │
│    - 같은 사용자 조문의 점수들을 평균              │
│    - 최고 점수(max_score) 기준 정렬                │
└────────────────────────────────────────────────────┘

검색 결과 (Top-3 사용자 조문):
  1. 사용자 제1조: 0.82 (5개 하위항목 매칭)
  2. 사용자 제2조: 0.71 (3개 하위항목 매칭)
  3. 사용자 제5조: 0.65 (2개 하위항목 매칭)
```



### 3.3 LLM 재검증

#### MatchingVerifier.verify_missing_article_forward()

```
입력:
  - 표준 조문: 제1조 (계약의 목적)
  - 사용자 후보: 제1조, 제2조, 제5조

LLM 프롬프트:
┌────────────────────────────────────────────────────────┐
│ **표준 조항 (제1조):**                                  │
│ 본 계약은 데이터 제공에 관한 사항을 정의한다...         │
│                                                        │
│ **사용자 계약서 후보 조항 (Top-3):**                    │
│                                                        │
│ **후보 1: 제1조 (계약 목적)** (유사도: 0.82)            │
│ 본 계약은 데이터 제공 및 활용에 관한...                 │
│                                                        │
│ **후보 2: 제2조 (용어 정의)** (유사도: 0.71)            │
│ 본 계약에서 사용하는 용어의 정의는...                   │
│                                                        │
│ **후보 3: 제5조 (계약 기간)** (유사도: 0.65)            │
│ 본 계약의 유효기간은...                                 │
│                                                        │
│ **과제**: 각 후보가 표준 조항의 내용을 포함하는지 분석  │
│ - 부분 일치: 핵심 내용은 같으나 표현/조건 차이          │
│ - 무관: 내용적으로 관련없음                             │
└────────────────────────────────────────────────────────┘

LLM 응답 (JSON):
{
  "candidates": [
    {
      "candidate_id": "제1조",
      "is_match": true,
      "confidence": 0.85,
      "match_type": "부분 일치(표현 차이)",
      "reasoning": "후보는 '데이터 제공 및 활용'이라고 명시하여...",
      "risk": "해당 조항이 없으면 계약 목적이 불명확해질 수 있습니다...",
      "recommendation": "계약 목적을 명확히 할 것을 권장합니다"
    },
    {
      "candidate_id": "제2조",
      "is_match": false,
      "confidence": 0.3,
      "match_type": "무관",
      "reasoning": "용어 정의 조항으로 계약 목적과는 무관...",
      ...
    },
    ...
  ],
  "summary": "제1조가 표준 조항의 내용을 포함하고 있어 누락이 아님",
  "overall_risk": "해당 조항이 없으면 계약 전체의 목적이..."
}

최종 판단:
  is_truly_missing: false (제1조에 포함됨)
  matched_user_article: 제1조
  confidence: 0.85
```



---

## 하이브리드 검색 상세 (HybridSearcher)

### 검색 가중치 구조

```
최종 점수 = Dense × 0.85 + Sparse × 0.15

Dense (FAISS 벡터 검색):
  = text_score × 0.7 + title_score × 0.3
  
  text_score:  text_norm 인덱스 검색 결과
  title_score: title 인덱스 검색 결과

Sparse (Whoosh BM25):
  = text_score × 0.7 + title_score × 0.3
  
  text_score:  text_norm 필드 BM25 점수
  title_score: title 필드 BM25 점수
```

### 검색 프로세스

```
1. Dense 검색 (FAISS)
┌────────────────────────────────────────────────────┐
│ text_query 임베딩 → text_norm 인덱스 검색 (Top-50) │
│ title_query 임베딩 → title 인덱스 검색 (Top-50)    │
│                                                    │
│ 청크별 점수 계산:                                   │
│   dense_score = text_score × 0.7 + title_score × 0.3│
│                                                    │
│ L2 거리 → 유사도 변환:                              │
│   similarity = 1.0 / (1.0 + distance)              │
└────────────────────────────────────────────────────┘

2. Sparse 검색 (Whoosh)
┌────────────────────────────────────────────────────┐
│ WhooshSearcher.search_with_field_weights()         │
│                                                    │
│ text_norm 필드 검색 (BM25)                         │
│ title 필드 검색 (BM25)                             │
│                                                    │
│ 청크별 점수 계산:                                   │
│   sparse_score = text_score × 0.7 + title_score × 0.3│
└────────────────────────────────────────────────────┘

3. 점수 정규화 (Min-Max)
┌────────────────────────────────────────────────────┐
│ Dense 결과: [0.85, 0.82, 0.79, ...] → [1.0, 0.5, 0.0, ...]│
│ Sparse 결과: [12.5, 10.2, 8.7, ...] → [1.0, 0.6, 0.3, ...]│
│                                                    │
│ normalized = (score - min) / (max - min)          │
└────────────────────────────────────────────────────┘

4. 점수 융합 (Weighted Sum)
┌────────────────────────────────────────────────────┐
│ 청크별 최종 점수:                                   │
│   final_score = dense_norm × 0.85 + sparse_norm × 0.15│
│                                                    │
│ Adaptive Weighting:                                │
│   - Sparse 결과 없으면 Dense 가중치 1.0으로 조정   │
│   - 0.85 상한 문제 해결                            │
└────────────────────────────────────────────────────┘

5. 최종 정렬 및 반환
┌────────────────────────────────────────────────────┐
│ final_score 기준 내림차순 정렬                      │
│ Top-K 청크 반환                                    │
└────────────────────────────────────────────────────┘
```



---

## 전체 데이터 흐름 다이어그램

```
┌─────────────────────────────────────────────────────────────────────┐
│                        사용자 계약서 조문                            │
│                     제3조 (데이터 제공 범위)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │ 하위항목 1   │  │ 하위항목 2   │  │ 하위항목 3   │              │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘              │
└─────────┼──────────────────┼──────────────────┼────────────────────┘
          │                  │                  │
          ↓                  ↓                  ↓
    ┌─────────────────────────────────────────────────┐
    │         ArticleMatcher (멀티벡터 검색)          │
    │                                                 │
    │  각 하위항목별로:                                │
    │  1. 정규화 (번호 제거)                          │
    │  2. 쿼리 생성 (제목/본문 분리)                  │
    │  3. 하이브리드 검색 (Top-K 청크)                │
    │  4. 조 단위 집계 (최고 점수)                    │
    └─────────────────┬───────────────────────────────┘
                      │
                      ↓
    ┌─────────────────────────────────────────────────┐
    │          HybridSearcher (FAISS + Whoosh)        │
    │                                                 │
    │  ┌──────────────────┐  ┌──────────────────┐    │
    │  │ Dense (0.85)     │  │ Sparse (0.15)    │    │
    │  │                  │  │                  │    │
    │  │ FAISS 벡터 검색  │  │ Whoosh BM25      │    │
    │  │ - text (0.7)     │  │ - text (0.7)     │    │
    │  │ - title (0.3)    │  │ - title (0.3)    │    │
    │  └────────┬─────────┘  └────────┬─────────┘    │
    │           │                     │               │
    │           └──────────┬──────────┘               │
    │                      ↓                          │
    │            정규화 + 가중합 융합                  │
    └─────────────────┬───────────────────────────────┘
                      │
                      ↓
          Top-K 청크 (parent_id로 그룹화)
                      │
                      ↓
    ┌─────────────────────────────────────────────────┐
    │      조 단위 집계 (_aggregate_sub_item_results)  │
    │                                                 │
    │  표준 제2조: 평균 0.845 (하위항목 2개)           │
    │  표준 제3조: 평균 0.79 (하위항목 1개)            │
    │                                                 │
    │  정렬: 1) 하위항목 개수 2) 평균 점수 3) 조 번호  │
    └─────────────────┬───────────────────────────────┘
                      │
                      ↓
    ┌─────────────────────────────────────────────────┐
    │      MatchingVerifier (LLM 검증)                │
    │                                                 │
    │  프롬프트:                                       │
    │  - 사용자 조문 내용                              │
    │  - 후보 표준 조문들 (Top-5)                      │
    │                                                 │
    │  LLM 판단:                                      │
    │  - 실제로 관련있는 조항 선택                     │
    │  - 여러 개 선택 가능                             │
    └─────────────────┬───────────────────────────────┘
                      │
                      ↓
          최종 매칭 결과: ["제2조", "제3조"]
```



---

## 역방향 검증 데이터 흐름

```
┌─────────────────────────────────────────────────────────────────────┐
│                   정방향 매칭 완료 후 누락 조문 식별                 │
│                                                                     │
│  매칭됨: 제2조, 제3조, 제5조                                         │
│  누락됨: 제1조, 제4조, 제6조  ← 이들을 재검증                       │
└─────────────────────────────────┬───────────────────────────────────┘
                                  │
                                  ↓
    ┌─────────────────────────────────────────────────┐
    │  사용자 FAISS 인덱스 생성 (1회만)               │
    │  build_user_faiss_index()                       │
    │                                                 │
    │  사용자 계약서의 모든 하위항목 임베딩 수집:      │
    │  - 제1조 하위항목 1, 2, 3                       │
    │  - 제2조 하위항목 1, 2                          │
    │  - ...                                          │
    │                                                 │
    │  FAISS 인덱스 구축 (L2 거리)                    │
    └─────────────────┬───────────────────────────────┘
                      │
                      ↓
    ┌─────────────────────────────────────────────────┐
    │  각 누락 조문에 대해 역방향 검색                 │
    │  find_matching_user_articles()                  │
    │                                                 │
    │  표준 제1조 (계약의 목적)                        │
    │  ├─ 청크 1 임베딩 → 사용자 FAISS 검색 (Top-10)  │
    │  ├─ 청크 2 임베딩 → 사용자 FAISS 검색 (Top-10)  │
    │  └─ 청크 3 임베딩 → 사용자 FAISS 검색 (Top-10)  │
    │                                                 │
    │  검색 결과를 조 단위로 집계:                     │
    │  - 사용자 제1조: 0.82 (5개 하위항목 매칭)        │
    │  - 사용자 제2조: 0.71 (3개 하위항목 매칭)        │
    │  - 사용자 제5조: 0.65 (2개 하위항목 매칭)        │
    └─────────────────┬───────────────────────────────┘
                      │
                      ↓
    ┌─────────────────────────────────────────────────┐
    │  LLM 재검증                                      │
    │  verify_missing_article_forward()               │
    │                                                 │
    │  프롬프트:                                       │
    │  - 표준 조문: 제1조 (계약의 목적)                │
    │  - 사용자 후보: 제1조, 제2조, 제5조              │
    │                                                 │
    │  LLM 판단 (각 후보별):                           │
    │  - is_match: true/false                         │
    │  - confidence: 0.0~1.0                          │
    │  - match_type: "부분 일치" | "무관"             │
    │  - reasoning: 상세 분석                          │
    │  - risk: 위험도 평가                             │
    │  - recommendation: 권고사항                      │
    └─────────────────┬───────────────────────────────┘
                      │
                      ↓
    ┌─────────────────────────────────────────────────┐
    │  최종 판단                                       │
    │                                                 │
    │  is_truly_missing: false                        │
    │  matched_user_article: 제1조                     │
    │  confidence: 0.85                               │
    │  reasoning: "사용자 제1조가 표준 조항의..."      │
    │  recommendation: "계약 목적을 명확히..."         │
    └─────────────────────────────────────────────────┘
```



---

## 핵심 알고리즘 및 수식

### 1. 멀티벡터 검색

사용자 조문 $A$가 $n$개의 하위항목 $\{s_1, s_2, ..., s_n\}$을 가질 때:

```
각 하위항목 s_i에 대해:
  1. 하이브리드 검색 수행 → Top-K 청크
  2. 청크를 parent_id로 그룹화
  3. 각 조의 최고 점수 선택: max_score_i(조)
  
조 단위 집계:
  - 같은 조를 선택한 하위항목들의 점수 평균
  - 매칭 하위항목 개수 카운트
  
정렬 기준:
  1. 매칭 하위항목 개수 (내림차순)
  2. 평균 점수 (내림차순)
  3. 조 번호 (오름차순)
```

### 2. 하이브리드 검색 점수 계산

```
Dense 점수 (FAISS):
  text_score = 1 / (1 + L2_distance_text)
  title_score = 1 / (1 + L2_distance_title)
  dense_score = text_score × 0.7 + title_score × 0.3

Sparse 점수 (Whoosh BM25):
  text_score = BM25(query, text_norm)
  title_score = BM25(query, title)
  sparse_score = text_score × 0.7 + title_score × 0.3

정규화 (Min-Max):
  normalized_dense = (dense - min_dense) / (max_dense - min_dense)
  normalized_sparse = (sparse - min_sparse) / (max_sparse - min_sparse)

최종 점수:
  final_score = normalized_dense × 0.85 + normalized_sparse × 0.15
  
Adaptive Weighting (Sparse 결과 없을 때):
  final_score = normalized_dense × 1.0
```

### 3. 역방향 검색 유사도

표준 조문의 청크 $c$와 사용자 하위항목 $s$의 유사도:

```
L2 거리 기반 유사도:
  similarity(c, s) = 1 / (1 + L2_distance(embedding_c, embedding_s))

조 단위 집계:
  - 같은 사용자 조문의 모든 매칭 점수 수집
  - max_score: 최고 점수
  - avg_score: 평균 점수
  
정렬: max_score 기준 내림차순
```



---

## 성능 최적화 전략

### 1. 임베딩 재사용

```
사용자 계약서 업로드 시:
  ├─ 파싱 단계에서 임베딩 생성 (EmbeddingService)
  │   ├─ 조 제목 임베딩
  │   └─ 각 하위항목 본문 임베딩
  └─ DB에 저장 (embeddings 테이블)

A1 노드 검색 시:
  ├─ DB에서 임베딩 로드 (EmbeddingLoader)
  └─ Azure OpenAI API 호출 없이 검색 수행
  
토큰 절약:
  - 정방향 검색: 임베딩 API 호출 0회
  - 역방향 검색: 임베딩 API 호출 0회
  - LLM 검증만 API 사용
```

### 2. FAISS 인덱스 캐싱

```
KnowledgeBaseLoader:
  ├─ 계약 유형별 FAISS 인덱스 메모리 캐싱
  ├─ 청크 메타데이터 캐싱
  └─ Whoosh 인덱스 캐싱

HybridSearcher:
  └─ 계약 유형별 searcher 인스턴스 캐싱
  
재사용:
  - 같은 계약 유형의 여러 조문 검색 시 인덱스 재로드 불필요
  - 메모리 효율성 향상
```

### 3. 배치 처리

```
역방향 검증:
  ├─ 사용자 FAISS 인덱스 1회만 생성
  └─ 모든 누락 조문에 대해 재사용
  
이점:
  - 인덱스 생성 오버헤드 최소화
  - 검색 속도 향상
```

### 4. Adaptive Weighting

```
Sparse 검색 결과 없을 때:
  ├─ Dense 가중치 자동 1.0 조정
  └─ 0.85 상한 문제 해결
  
이점:
  - 검색 품질 유지
  - 특수 케이스 대응
```



---

## 주요 설정 파라미터

### 검색 가중치

| 파라미터 | 기본값 | 설명 |
|---------|-------|------|
| `dense_weight` | 0.85 | FAISS 벡터 검색 가중치 |
| `sparse_weight` | 0.15 | Whoosh BM25 검색 가중치 (자동 계산) |
| `text_weight` | 0.7 | 본문 검색 가중치 |
| `title_weight` | 0.3 | 제목 검색 가중치 (자동 계산) |

### 검색 파라미터

| 파라미터 | 기본값 | 설명 |
|---------|-------|------|
| `top_k` | 1 | 하위항목별 최종 반환 조 개수 |
| `dense_top_k` | 50 | Dense 검색 중간 결과 개수 |
| `sparse_top_k` | 50 | Sparse 검색 중간 결과 개수 |
| `matching_threshold` | 0.7 | 매칭 성공 임계값 |
| `special_threshold` | 0.3 | 특수 조항 임계값 |

### LLM 검증 파라미터

| 파라미터 | 기본값 | 설명 |
|---------|-------|------|
| `model` | gpt-4o | LLM 모델명 |
| `temperature` | 0.3 (선택), 0.1 (재검증) | LLM 온도 |
| `max_tokens` | 500 (선택), 1500 (재검증) | 최대 토큰 수 |
| `top_k_verify` | 5 | LLM 검증 대상 후보 개수 |

### 역방향 검증 파라미터

| 파라미터 | 기본값 | 설명 |
|---------|-------|------|
| `reverse_top_k` | 3 | 역방향 검색 후보 개수 |
| `reverse_search_k` | 10 | 청크별 검색 결과 개수 |
| `similarity_threshold` | 0.5 | 역방향 검색 임계값 |

---

## 로깅 및 디버깅

### 로그 레벨별 출력

```python
# INFO 레벨
logger.info(f"A1 완전성 검증 시작: {contract_id}")
logger.info(f"  사용자 조문: {total_user_articles}개")
logger.info(f"  매칭 완료: 사용자 {matched}/{total}")

# DEBUG 레벨
logger.debug(f"    하위항목 {idx} 검색: text={text_query[:50]}...")
logger.debug(f"      → {best_article['parent_id']}: {score:.3f}")

# WARNING 레벨
logger.warning(f"  매칭 실패: 검색결과 없음")
logger.warning(f"    임베딩 없는 청크: {count}개")

# ERROR 레벨
logger.error(f"  표준계약서 데이터 로드 실패: {contract_type}")
```

### 주요 진단 정보

```
하이브리드 검색:
  ✓ Faiss 검색완료: 45건(본문: 30, 제목: 25)
  Dense top-k: 45건 점수 범위 [0.6234 ~ 0.8912]
  Sparse top-k: 38개, 점수 범위 [5.2341 ~ 12.8765]
  Sparse-Dense 중복: 28/50 (56.0%)
  가중치 - Dense: 0.85, Sparse: 0.15

조 단위 집계:
  1. 제2조: 0.845 (D:0.87, S:0.75, 하위항목:2)
  2. 제3조: 0.790 (D:0.82, S:0.68, 하위항목:1)

역방향 검색:
  사용자 조문 FAISS 인덱스 생성 중...
    - 사용자 조문 수: 15개
    - contract_id: user_contract_001
  ✓ FAISS 인덱스 생성 완료: 45개 하위항목
  총 12개 청크 검색, 35개 매칭 발견
```



---

## 예시: 전체 흐름 실행

### 입력

```json
{
  "contract_id": "user_contract_001",
  "contract_type": "provide",
  "user_article": {
    "number": 3,
    "title": "데이터 제공 범위",
    "text": "갑은 다음 각 호의 데이터를 제공한다.",
    "content": [
      "별지1에 기재된 데이터 항목",
      "데이터 형식은 JSON 또는 CSV로 한다",
      "제공 주기는 월 1회로 하되, 필요시 협의하여 변경할 수 있다"
    ]
  }
}
```

### 1단계: 멀티벡터 검색

```
하위항목 1: "별지1에 기재된 데이터 항목"
  → 하이브리드 검색 (Top-1 청크)
  → 표준 제2조: 0.87 (청크 3개)

하위항목 2: "데이터 형식은 JSON 또는 CSV로 한다"
  → 하이브리드 검색 (Top-1 청크)
  → 표준 제2조: 0.82 (청크 2개)

하위항목 3: "제공 주기는 월 1회로 하되..."
  → 하이브리드 검색 (Top-1 청크)
  → 표준 제3조: 0.79 (청크 1개)
```

### 2단계: 조 단위 집계

```
표준 제2조 (데이터 제공 범위 및 방식):
  - 하위항목 1: 0.87
  - 하위항목 2: 0.82
  → 평균: 0.845, 매칭 하위항목: 2개

표준 제3조 (데이터 제공 주기):
  - 하위항목 3: 0.79
  → 평균: 0.79, 매칭 하위항목: 1개

정렬 결과:
  1위: 제2조 (하위항목 2개, 평균 0.845)
  2위: 제3조 (하위항목 1개, 평균 0.79)
```

### 3단계: LLM 검증

```
프롬프트:
  사용자 조문: 제3조 (데이터 제공 범위)
  후보 조문:
    - 제2조 (데이터 제공 범위 및 방식) [0.845]
    - 제3조 (데이터 제공 주기) [0.79]

LLM 응답:
  선택된 조항: 제2조, 제3조
  
이유:
  - 제2조: 데이터 항목 및 형식 관련 내용 포함
  - 제3조: 제공 주기 관련 내용 포함
```

### 최종 출력

```json
{
  "user_article_no": 3,
  "user_article_title": "데이터 제공 범위",
  "matched": true,
  "matched_articles": ["제2조", "제3조"],
  "matched_articles_global_ids": [
    "urn:std:provide:art:002",
    "urn:std:provide:art:003"
  ],
  "matched_articles_details": [
    {
      "parent_id": "제2조",
      "global_id": "urn:std:provide:art:002",
      "title": "데이터 제공 범위 및 방식",
      "combined_score": 0.845,
      "num_sub_items": 2,
      "matched_sub_items": [1, 2],
      "avg_dense_score": 0.87,
      "avg_sparse_score": 0.75,
      "sub_items_scores": [...]
    },
    {
      "parent_id": "제3조",
      "global_id": "urn:std:provide:art:003",
      "title": "데이터 제공 주기",
      "combined_score": 0.79,
      "num_sub_items": 1,
      "matched_sub_items": [3],
      "avg_dense_score": 0.82,
      "avg_sparse_score": 0.68,
      "sub_items_scores": [...]
    }
  ],
  "verification_details": []
}
```



---

## 시각적 요약: 검색 파이프라인

```
┌─────────────────────────────────────────────────────────────────────┐
│                          INPUT: 사용자 조문                          │
│                     제3조 (데이터 제공 범위)                         │
│                    하위항목 1, 2, 3                                  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 1: 멀티벡터 검색                             │
│                                                                     │
│  각 하위항목 → 정규화 → 쿼리 생성 → 하이브리드 검색 → 조 집계      │
│                                                                     │
│  ┌──────────────────────────────────────────────────────────────┐  │
│  │  하이브리드 검색 (FAISS 0.85 + Whoosh 0.15)                  │  │
│  │                                                              │  │
│  │  Dense (FAISS):                  Sparse (Whoosh):           │  │
│  │  ├─ text_norm (0.7)              ├─ text_norm (0.7)         │  │
│  │  └─ title (0.3)                  └─ title (0.3)             │  │
│  │                                                              │  │
│  │  정규화 → 가중합 → Top-K 청크                                │  │
│  └──────────────────────────────────────────────────────────────┘  │
│                                                                     │
│  결과: 하위항목별 최고 점수 조 선정                                  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 2: 조 단위 집계                              │
│                                                                     │
│  같은 조를 선택한 하위항목들의 점수 평균                             │
│  정렬: 1) 하위항목 개수 2) 평균 점수 3) 조 번호                      │
│                                                                     │
│  제2조: 0.845 (하위항목 2개)                                         │
│  제3조: 0.79 (하위항목 1개)                                          │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 3: LLM 검증                                  │
│                                                                     │
│  프롬프트: 사용자 조문 + 후보 조문들 (Top-5)                         │
│  LLM 판단: 실제로 관련있는 조항 선택 (여러 개 가능)                  │
│                                                                     │
│  선택: 제2조, 제3조                                                  │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    OUTPUT: 최종 매칭 결과                            │
│                                                                     │
│  matched: true                                                      │
│  matched_articles: ["제2조", "제3조"]                                │
│  matched_articles_details: [상세 점수 정보]                          │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 역방향 검증 파이프라인

```
┌─────────────────────────────────────────────────────────────────────┐
│                    INPUT: 누락된 표준 조문                           │
│                     제1조 (계약의 목적)                              │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│              STEP 1: 사용자 FAISS 인덱스 생성 (1회)                  │
│                                                                     │
│  사용자 계약서의 모든 하위항목 임베딩 수집                           │
│  FAISS 인덱스 구축 (L2 거리)                                         │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│              STEP 2: 역방향 검색 (표준 → 사용자)                     │
│                                                                     │
│  표준 조문의 각 청크 임베딩 → 사용자 FAISS 검색 (Top-10)             │
│  조 단위 집계 (max_score 기준)                                       │
│                                                                     │
│  사용자 제1조: 0.82 (5개 하위항목)                                   │
│  사용자 제2조: 0.71 (3개 하위항목)                                   │
│  사용자 제5조: 0.65 (2개 하위항목)                                   │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    STEP 3: LLM 재검증                                │
│                                                                     │
│  프롬프트: 표준 조문 + 사용자 후보들 (Top-3)                         │
│  LLM 판단 (각 후보별):                                               │
│    - is_match: true/false                                           │
│    - confidence: 0.0~1.0                                            │
│    - reasoning: 상세 분석                                            │
│    - risk: 위험도 평가                                               │
│                                                                     │
│  후보 1 (제1조): is_match=true, confidence=0.85                      │
│  후보 2 (제2조): is_match=false, confidence=0.3                      │
│  후보 3 (제5조): is_match=false, confidence=0.2                      │
└────────────────────────────┬────────────────────────────────────────┘
                             │
                             ↓
┌─────────────────────────────────────────────────────────────────────┐
│                    OUTPUT: 재검증 결과                               │
│                                                                     │
│  is_truly_missing: false (제1조에 포함됨)                            │
│  matched_user_article: 제1조                                         │
│  confidence: 0.85                                                   │
│  reasoning: "사용자 제1조가 표준 조항의 내용을 포함..."               │
│  recommendation: "계약 목적을 명확히 할 것을 권장..."                 │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 참고 자료

### 관련 파일

- `backend/consistency_agent/a1_node/a1_node.py`: A1 노드 메인 로직
- `backend/consistency_agent/a1_node/article_matcher.py`: 검색 엔진
- `backend/consistency_agent/a1_node/matching_verifier.py`: LLM 검증
- `backend/consistency_agent/hybrid_searcher.py`: 하이브리드 검색
- `backend/shared/services/knowledge_base_loader.py`: 인덱스 로더
- `backend/shared/services/whoosh_searcher.py`: Whoosh 검색
- `backend/shared/services/embedding_loader.py`: 임베딩 로더

### 관련 문서

- `docs/HYBRID_SEARCH_LOGIC.md`: 하이브리드 검색 로직 상세
- `docs/A1_MISSING_VERIFICATION.md`: 누락 검증 로직 상세
- `docs/DATA_SHARING_AND_DB.md`: 데이터 공유 및 DB 구조

---

**작성일**: 2025-11-03  
**버전**: 1.0
