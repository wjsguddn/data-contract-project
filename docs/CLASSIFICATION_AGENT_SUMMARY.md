# Classification Agent 3줄 요약 (PPT용)

## 핵심 요약

1. **벡터 유사도 계산**: 사용자 계약서의 주요 조항을 FAISS 벡터 검색으로 표준계약서 5종과 비교하여 유사도 점수 계산

2. **Hybrid Gating 방식**: 1위-2위 점수 차이가 크면 임베딩 결과 사용, 차이가 작으면 Few-shot 프롬프트로 GPT-4 정밀 분류 수행

3. **신뢰도 평가**: 분류 결과에 대한 신뢰도 점수와 근거를 함께 제공하여 사용자가 결과를 검토하고 필요시 수정 가능

---

## 상세 설명 (필요시)

### 1단계: 사용자 계약서 파싱
- **입력**: 사용자가 업로드한 DOCX 계약서
- **처리**: "제n조" 패턴으로 조항 추출
- **출력**: 구조화된 JSON 데이터 (조 단위)

### 2단계: 벡터 유사도 계산 (FAISS)
- **임베딩 생성**: 주요 조항 5개를 Azure OpenAI로 벡터화
- **유사도 계산**: 5종 표준계약서 각각과 코사인 유사도 계산
- **점수 산출**: 각 유형별 평균 유사도 점수 (0~1)
- **출력**: 5종 유형별 유사도 점수

### 3단계: Hybrid Gating 분류
- **Gating 조건**: 1위-2위 점수 차이 ≥ 0.05
  - **차이 큼** → 임베딩 결과 사용 (LLM 호출 없음, 빠름)
  - **차이 작음** → Few-shot LLM 분류 (정밀 분석)
- **Few-shot 프롬프트**: 5종 유형별 예시와 특징 제공
- **출력**: 
  - 분류 결과 (5종 중 1개)
  - 신뢰도 점수 (0~1)
  - 분류 근거 및 방법 (embedding/llm_fewshot)

### 4단계: 결과 저장 및 검토
- **데이터베이스 저장**: 분류 결과 및 메타데이터
- **사용자 검토**: Streamlit UI에서 결과 확인
- **수정 가능**: 사용자가 분류 결과 변경 가능
- **다음 단계**: Consistency Agent로 전달

---

## 5종 표준계약서 유형

| 유형 | 설명 |
|-----|------|
| 데이터 제공 계약 | 데이터 제공자가 수요자에게 데이터를 제공 |
| 데이터 거래 계약 | 데이터의 매매 및 거래 |
| 데이터 가공 계약 | 데이터 가공 및 처리 서비스 |
| 데이터 구축 계약 | 데이터 수집 및 구축 |
| 데이터 처리 위탁 계약 | 데이터 처리 업무 위탁 |

---

## Hybrid Gating 방식

### 임베딩 기반 분류 (빠른 경로)
- **조건**: 1위-2위 점수 차이 ≥ 0.05
- **장점**: LLM 호출 없이 즉시 분류 (비용 절감, 속도 향상)
- **예시**: provide(0.85) vs create(0.65) → gap=0.20 → 임베딩 결과 사용
- **신뢰도**: 1위 유사도 점수 그대로 사용

### Few-shot LLM 분류 (정밀 경로)
- **조건**: 1위-2위 점수 차이 < 0.05 (애매한 경우)
- **방식**: 5종 유형별 예시와 특징을 프롬프트에 포함
- **예시**: provide(0.72) vs create(0.70) → gap=0.02 → LLM 정밀 분석
- **장점**: 복잡하거나 혼합형 계약서도 정확히 분류

### Gating 임계값
```
score_gap = top1_score - top2_score

if score_gap >= 0.05:
    → 임베딩 결과 사용 (classification_method: "embedding")
else:
    → Few-shot LLM 분류 (classification_method: "llm_fewshot")
```

---

## Few-shot 프롬프트 구조

```
[시스템 역할]
당신은 데이터 계약서 분류 전문가입니다.

[Few-shot 예시]
예시 1: 데이터 제공형 (provide)
- 역할 구조: 제공자 → 이용자
- 핵심 패턴: "대상데이터 제공", "이용허락", "대가 지급"
- 출력: {"type": "provide", "confidence": 0.95, "reason": "..."}

예시 2: 데이터 생성형 (create)
- 역할 구조: 공동 생성
- 핵심 패턴: "공동 생성", "파생데이터", "이익분배"
- 출력: {"type": "create", "confidence": 0.93, "reason": "..."}

... (5종 모두 예시 제공)

[입력 데이터]
1. 사용자 계약서 주요 조항 (처음 5개)
2. 임베딩 유사도 점수 (참고용)

[분석 지침]
1. 역할 구조 파악
2. 핵심 패턴 찾기
3. 데이터 흐름 확인

[출력 형식 (JSON)]
{
  "type": "[provide|create|process|brokerage_provider|brokerage_user]",
  "confidence": 0.0~1.0,
  "reason": "판단 근거"
}
```

---

## 성능 지표

### 처리 시간
- 파싱: 1~2초
- 임베딩 생성: 1~2초
- 벡터 유사도 계산: 1초 미만
- **임베딩 경로**: 약 3~5초 (LLM 호출 없음)
- **Few-shot LLM 경로**: 약 8~12초 (LLM 호출 포함)
- **평균 소요 시간**: 약 5~10초

### 정확도
- 명확한 계약서: 90% 이상
- 혼합형 계약서: 70~80%
- 비정형 계약서: Phase 2에서 개선 예정

---

## 기술 스택

| 구성 요소 | 기술 |
|---------|------|
| 파싱 | python-docx |
| 벡터 검색 | FAISS (IndexFlatIP, 코사인 유사도) |
| 임베딩 | Azure OpenAI (text-embedding-3-large, 3072차원) |
| LLM | Azure OpenAI (GPT-4o, Few-shot 프롬프트) |
| Gating | 점수 차이 임계값 0.05 |
| 비동기 처리 | Celery + Redis |

---

## 데이터 플로우

```
사용자 계약서 업로드
    ↓
파싱 (조 단위 추출)
    ↓
임베딩 생성 (주요 조항 5개)
    ↓
벡터 유사도 계산 (FAISS)
    ↓
Hybrid Gating 판단
    ├─ 점수 차이 큼 → 임베딩 결과 사용
    └─ 점수 차이 작음 → Few-shot LLM 분류
    ↓
결과 저장 (DB)
    ↓
사용자 검토 (UI)
    ↓
Consistency Agent로 전달
```

---

## 사용자 인터페이스

### 분류 결과 표시
- **계약서 유형**: 데이터 제공 계약
- **신뢰도**: 95%
- **분류 근거**: 
  - 제1조: 데이터 제공 목적 명시
  - 제3조: 제공 데이터 범위 정의
  - 제5조: 데이터 제공 방법 및 절차

### 수정 기능
- 드롭다운으로 다른 유형 선택 가능
- 수정 사유 입력
- 수정 이력 저장

---

## 에러 처리

### 분류 실패 케이스
1. **신뢰도 낮음** (< 0.5): 사용자에게 수동 분류 요청
2. **검색 결과 없음**: 표준계약서와 유사도가 너무 낮음
3. **LLM 오류**: Azure OpenAI API 장애

### 경고 케이스
1. **혼합형 계약서**: 여러 유형의 특징이 섞여 있음
2. **비정형 구조**: "제n조" 패턴이 불규칙함

---

## Phase 2 개선 계획

### 고도화 기능
1. **다중 분류**: 혼합형 계약서를 여러 유형으로 분류
2. **세부 분류**: 각 유형의 하위 카테고리 분류
3. **신뢰도 향상**: 더 많은 학습 데이터 및 Fine-tuning
4. **실시간 피드백**: 사용자 수정 내역을 학습에 반영
